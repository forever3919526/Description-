<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>斗地主 - 精美版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" patternUnits="userSpaceOnUse" width="100" height="100"><circle cx="50" cy="50" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }

        /* 主菜单界面 */
        .main-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            z-index: 100;
        }

        .game-title {
            font-size: 4rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 2rem;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 3px 3px 6px rgba(0,0,0,0.5), 0 0 20px #ffd700; }
            to { text-shadow: 3px 3px 6px rgba(0,0,0,0.5), 0 0 40px #ffd700; }
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .menu-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .menu-btn.secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        /* 房间界面 */
        .room-interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 90;
        }

        .room-header {
            height: 80px;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            color: white;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .room-id {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .coins-display {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .room-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        /* 游戏界面 */
        .game-interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        .game-table {
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #2d5a27 0%, #1a3318 100%);
            position: relative;
            border: 8px solid #8b4513;
            border-radius: 20px;
        }

        /* 玩家位置 */
        .player-area {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-bottom {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .player-left {
            left: 20px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
        }

        .player-right {
            right: 20px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
        }

        .player-info {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* 扑克牌样式 */
        .card {
            width: 60px;
            height: 80px;
            background: white;
            border-radius: 8px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 -15px;
            font-weight: bold;
        }

        .card:hover {
            transform: translateY(-10px);
        }

        .card.selected {
            transform: translateY(-20px);
            box-shadow: 0 8px 16px rgba(255,215,0,0.6);
        }

        .card.red {
            color: #d32f2f;
        }

        .card.black {
            color: #333;
        }

        .card-back {
            background: linear-gradient(45deg, #1565c0, #0d47a1);
            color: white;
        }

        /* 手牌区域 */
        .hand-cards {
            display: flex;
            justify-content: center;
            padding: 0 2rem;
        }

        /* 出牌区域 */
        .play-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .last-play {
            display: flex;
            gap: 5px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
        }

        /* 控制按钮 */
        .game-controls {
            position: absolute;
            bottom: 120px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-play {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
        }

        .btn-pass {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-hint {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }

        /* 抢地主界面 */
        .landlord-selection {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            color: white;
            display: none;
        }

        .landlord-btns {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* 游戏状态显示 */
        .game-status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2.5rem;
            }
            
            .card {
                width: 45px;
                height: 60px;
                font-size: 0.8rem;
            }
            
            .player-info {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }

        /* 动画效果 */
        @keyframes cardDeal {
            from {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .card-enter {
            animation: cardDeal 0.5s ease-out;
        }

        /* 音效控制 */
        .sound-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* 加载动画 */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
            gap: 10px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <button class="sound-toggle" onclick="toggleSound()">🔊</button>
        
        <!-- 主菜单 -->
        <div class="main-menu" id="mainMenu">
            <h1 class="game-title">🃏 斗地主</h1>
            <div class="menu-buttons">
                <button class="menu-btn" onclick="createRoom()">创建房间</button>
                <button class="menu-btn secondary" onclick="joinRoom()">加入房间</button>
                <button class="menu-btn secondary" onclick="showSettings()">设置</button>
            </div>
        </div>

        <!-- 房间界面 -->
        <div class="room-interface" id="roomInterface">
            <div class="room-header">
                <div class="room-info">
                    <div class="room-id">房间号: <span id="roomId">888888</span></div>
                    <div class="coins-display">💰 <span id="playerCoins">1000</span></div>
                </div>
                <button class="menu-btn" onclick="backToMenu()">返回大厅</button>
            </div>
            <div class="room-content">
                <div class="loading" id="waitingPlayers">
                    <div class="spinner"></div>
                    等待其他玩家加入...
                </div>
                <button class="menu-btn" onclick="startGame()" id="startGameBtn" style="display: none;">开始游戏</button>
            </div>
        </div>

        <!-- 游戏界面 -->
        <div class="game-interface" id="gameInterface">
            <div class="game-table">
                <div class="game-status" id="gameStatus">等待游戏开始...</div>
                
                <!-- 玩家区域 -->
                <div class="player-area player-left" id="leftPlayer">
                    <div class="player-info">
                        <div class="player-avatar">👤</div>
                        <span>玩家2</span>
                        <span class="card-count">(17张)</span>
                    </div>
                </div>
                
                <div class="player-area player-right" id="rightPlayer">
                    <div class="player-info">
                        <div class="player-avatar">👤</div>
                        <span>玩家3</span>
                        <span class="card-count">(17张)</span>
                    </div>
                </div>
                
                <div class="player-area player-bottom" id="bottomPlayer">
                    <div class="player-info">
                        <div class="player-avatar">👤</div>
                        <span>我</span>
                        <span class="card-count">(17张)</span>
                    </div>
                </div>

                <!-- 出牌区域 -->
                <div class="play-area" id="playArea">
                    <div class="last-play" id="lastPlay">
                        <!-- 最后出的牌 -->
                    </div>
                </div>

                <!-- 手牌区域 -->
                <div class="hand-cards" id="handCards">
                    <!-- 玩家手牌 -->
                </div>

                <!-- 游戏控制按钮 -->
                <div class="game-controls">
                    <button class="control-btn btn-hint" onclick="getHint()">提示</button>
                    <button class="control-btn btn-pass" onclick="passRound()">不出</button>
                    <button class="control-btn btn-play" onclick="playCards()">出牌</button>
                </div>
            </div>
        </div>

        <!-- 抢地主界面 -->
        <div class="landlord-selection" id="landlordSelection">
            <h3>抢地主</h3>
            <p>是否要抢地主？</p>
            <div class="landlord-btns">
                <button class="control-btn btn-play" onclick="grabLandlord(true)">抢地主</button>
                <button class="control-btn btn-pass" onclick="grabLandlord(false)">不抢</button>
            </div>
        </div>
    </div>

    <script>
        // 游戏状态管理
        class GameState {
            constructor() {
                this.currentView = 'menu';
                this.roomId = '';
                this.playerCoins = 1000;
                this.soundEnabled = true;
                this.gamePhase = 'waiting'; // waiting, bidding, playing, ended
                this.currentPlayer = 0;
                this.landlord = -1;
                this.selectedCards = [];
                this.handCards = [];
                this.lastPlay = [];
                this.players = [
                    { name: '我', cards: 17, avatar: '👤', isLandlord: false },
                    { name: '玩家2', cards: 17, avatar: '👤', isLandlord: false },
                    { name: '玩家3', cards: 17, avatar: '👤', isLandlord: false }
                ];
            }
        }

        const gameState = new GameState();

        // 扑克牌数据
        const SUITS = ['♠', '♥', '♦', '♣'];
        const RANKS = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2'];
        const JOKERS = ['小王', '大王'];

        // 音效系统
        class SoundManager {
            constructor() {
                this.enabled = true;
                this.audioContext = null;
                this.sounds = {};
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('音频不支持');
                }
            }

            playSound(type) {
                if (!this.enabled || !this.audioContext) return;
                
                // 简单的音效生成
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                const frequencies = {
                    'card': 800,
                    'select': 600,
                    'play': 1000,
                    'win': 1200,
                    'error': 300
                };
                
                oscillator.frequency.setValueAtTime(frequencies[type] || 500, this.audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.2);
            }
        }

        const soundManager = new SoundManager();

        // 扑克牌生成
        function generateDeck() {
            const deck = [];
            
            // 生成普通牌
            for (let suit of SUITS) {
                for (let rank of RANKS) {
                    deck.push({
                        suit,
                        rank,
                        value: RANKS.indexOf(rank) + 3,
                        display: rank + suit,
                        isRed: suit === '♥' || suit === '♦'
                    });
                }
            }
            
            // 添加大小王
            deck.push({
                suit: '',
                rank: '小王',
                value: 16,
                display: '🃏',
                isRed: false,
                isJoker: true
            });
            
            deck.push({
                suit: '',
                rank: '大王',
                value: 17,
                display: '🂿',
                isRed: true,
                isJoker: true
            });
            
            return deck;
        }

        // 洗牌算法
        function shuffleDeck(deck) {
            const shuffled = [...deck];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // 界面切换
        function showView(viewName) {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('roomInterface').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'none';
            
            switch (viewName) {
                case 'menu':
                    document.getElementById('mainMenu').style.display = 'flex';
                    break;
                case 'room':
                    document.getElementById('roomInterface').style.display = 'block';
                    break;
                case 'game':
                    document.getElementById('gameInterface').style.display = 'block';
                    break;
            }
            
            gameState.currentView = viewName;
        }

        // 创建房间
        function createRoom() {
            gameState.roomId = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById('roomId').textContent = gameState.roomId;
            document.getElementById('playerCoins').textContent = gameState.playerCoins;
            
            showView('room');
            soundManager.playSound('select');
            
            // 模拟其他玩家加入
            setTimeout(() => {
                document.getElementById('waitingPlayers').style.display = 'none';
                document.getElementById('startGameBtn').style.display = 'block';
            }, 2000);
        }

        // 加入房间
        function joinRoom() {
            const roomId = prompt('请输入房间号:');
            if (roomId && roomId.length === 6) {
                gameState.roomId = roomId;
                document.getElementById('roomId').textContent = roomId;
                createRoom(); // 简化处理，直接进入房间
            } else {
                alert('房间号格式不正确！');
            }
        }

        // 开始游戏
        function startGame() {
            showView('game');
            soundManager.playSound('play');
            initializeGame();
        }

        // 返回主菜单
        function backToMenu() {
            showView('menu');
            soundManager.playSound('select');
        }

        // 初始化游戏
        function initializeGame() {
            const deck = shuffleDeck(generateDeck());
            
            // 发牌
            gameState.handCards = deck.slice(0, 17);
            gameState.handCards.sort((a, b) => a.value - b.value);
            
            renderHandCards();
            updateGameStatus('请选择是否抢地主');
            
            // 显示抢地主界面
            setTimeout(() => {
                document.getElementById('landlordSelection').style.display = 'block';
            }, 1000);
        }

        // 渲染手牌
        function renderHandCards() {
            const handCardsEl = document.getElementById('handCards');
            handCardsEl.innerHTML = '';
            
            gameState.handCards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${card.isRed ? 'red' : 'black'} card-enter`;
                cardEl.textContent = card.display;
                cardEl.style.animationDelay = `${index * 0.05}s`;
                cardEl.onclick = () => selectCard(index);
                handCardsEl.appendChild(cardEl);
            });
        }

        // 选择卡牌
        function selectCard(index) {
            const cardIndex = gameState.selectedCards.indexOf(index);
            const cardEl = document.getElementById('handCards').children[index];
            
            if (cardIndex > -1) {
                gameState.selectedCards.splice(cardIndex, 1);
                cardEl.classList.remove('selected');
            } else {
                gameState.selectedCards.push(index);
                cardEl.classList.add('selected');
            }
            
            soundManager.playSound('select');
        }

        // 抢地主
        function grabLandlord(grab) {
            document.getElementById('landlordSelection').style.display = 'none';
            
            if (grab) {
                gameState.landlord = 0;
                gameState.players[0].isLandlord = true;
                updateGameStatus('你是地主！');
                soundManager.playSound('win');
            } else {
                // 随机分配地主
                gameState.landlord = Math.floor(Math.random() * 3);
                gameState.players[gameState.landlord].isLandlord = true;
                updateGameStatus(`${gameState.players[gameState.landlord].name}是地主！`);
            }
            
            gameState.gamePhase = 'playing';
            gameState.currentPlayer = gameState.landlord;
            
            setTimeout(() => {
                updateGameStatus('游戏开始！轮到你出牌');
            }, 2000);
        }

        // 出牌
        function playCards() {
            if (gameState.selectedCards.length === 0) {
                alert('请选择要出的牌！');
                return;
            }
            
            const selectedCards = gameState.selectedCards.map(i => gameState.handCards[i]);
            
            if (isValidPlay(selectedCards)) {
                // 从手牌中移除选中的牌
                gameState.selectedCards.sort((a, b) => b - a);
                gameState.selectedCards.forEach(index => {
                    gameState.handCards.splice(index, 1);
                });
                
                gameState.selectedCards = [];
                gameState.lastPlay = selectedCards;
                
                renderHandCards();
                renderLastPlay();
                soundManager.playSound('play');
                
                // 检查游戏结束
                if (gameState.handCards.length === 0) {
                    endGame(true);
                    return;
                }
                
                // 下一个玩家
                nextPlayer();
            } else {
                alert('出牌不符合规则！');
                soundManager.playSound('error');
            }
        }

        // 不出
        function passRound() {
            gameState.selectedCards = [];
            renderHandCards();
            nextPlayer();
            soundManager.playSound('select');
        }

        // 获取提示
        function getHint() {
            // 简单的提示逻辑
            if (gameState.handCards.length > 0) {
                gameState.selectedCards = [0];
                renderHandCards();
                document.getElementById('handCards').children[0].classList.add('selected');
                soundManager.playSound('select');
            }
        }

        // 验证出牌是否有效
        function isValidPlay(cards) {
            if (cards.length === 0) return false;
            
            // 简化验证：单张、对子、三张都算有效
            if (cards.length === 1) return true;
            if (cards.length === 2) {
                return cards[0].value === cards[1].value;
            }
            if (cards.length === 3) {
                return cards[0].value === cards[1].value && cards[1].value === cards[2].value;
            }
            
            return true; // 其他牌型暂时都认为有效
        }

        // 渲染最后出的牌
        function renderLastPlay() {
            const lastPlayEl = document.getElementById('lastPlay');
            lastPlayEl.innerHTML = '';
            
            gameState.lastPlay.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${card.isRed ? 'red' : 'black'}`;
                cardEl.textContent = card.display;
                cardEl.style.margin = '0 2px';
                lastPlayEl.appendChild(cardEl);
            });
        }

        // 下一个玩家
        function nextPlayer() {
            gameState.currentPlayer = (gameState.currentPlayer + 1) % 3;
            
            if (gameState.currentPlayer === 0) {
                updateGameStatus('轮到你出牌');
            } else {
                updateGameStatus(`轮到${gameState.players[gameState.currentPlayer].name}出牌`);
                
                // AI玩家自动出牌
                setTimeout(() => {
                    aiPlay();
                }, 1500);
            }
        }

        // AI玩家出牌 - 改进逻辑
        function aiPlay() {
            // 更智能的AI出牌逻辑
            const shouldPlay = Math.random() > 0.3; // 70%概率出牌
            
            if (!shouldPlay && gameState.lastPlay.length > 0) {
                // AI选择不出
                updateGameStatus(`${gameState.players[gameState.currentPlayer].name}选择不出`);
                nextPlayer();
                return;
            }
            
            // 随机选择出牌数量
            const aiCards = Math.floor(Math.random() * 3) + 1;
            
            // 模拟AI出牌
            const playedCards = [];
            const cardTypes = ['♠', '♥', '♦', '♣'];
            const cardValues = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2'];
            
            for (let i = 0; i < aiCards; i++) {
                const randomSuit = cardTypes[Math.floor(Math.random() * cardTypes.length)];
                const randomValue = cardValues[Math.floor(Math.random() * cardValues.length)];
                playedCards.push({
                    suit: randomSuit,
                    rank: randomValue,
                    value: cardValues.indexOf(randomValue) + 3,
                    display: randomValue + randomSuit,
                    isRed: randomSuit === '♥' || randomSuit === '♦'
                });
            }
            
            gameState.lastPlay = playedCards;
            gameState.players[gameState.currentPlayer].cards -= aiCards;
            
            renderLastPlay();
            updatePlayerCardCount();
            updateGameStatus(`${gameState.players[gameState.currentPlayer].name}出了${aiCards}张牌`);
            
            // 检查AI是否获胜
            if (gameState.players[gameState.currentPlayer].cards === 0) {
                endGame(false);
                return;
            }
            
            // 延迟后下一个玩家
            setTimeout(() => {
                nextPlayer();
            }, 1000);
        }

        // 更新玩家卡牌数量显示
        function updatePlayerCardCount() {
            const cardCounts = document.querySelectorAll('.card-count');
            cardCounts.forEach((el, index) => {
                el.textContent = `(${gameState.players[index].cards}张)`;
            });
        }

        // 更新游戏状态
        function updateGameStatus(status) {
            document.getElementById('gameStatus').textContent = status;
        }

        // 结束游戏
        function endGame(playerWon) {
            let coinsChange = 0;
            
            if (playerWon) {
                updateGameStatus('🎉 恭喜你获胜！');
                coinsChange = 100;
                gameState.playerCoins += coinsChange;
                soundManager.playSound('win');
                
                // 添加获胜动画
                document.getElementById('gameInterface').classList.add('winning-animation');
            } else {
                updateGameStatus('😔 游戏结束！');
                coinsChange = -50;
                gameState.playerCoins -= 50;
                soundManager.playSound('error');
            }
            
            // 更新统计
            gameStats.recordGame(playerWon, coinsChange);
            
            // 更新显示的金币数量
            document.getElementById('playerCoins').textContent = gameState.playerCoins;
            
            // 显示游戏统计
            const stats = gameStats.getStats();
            setTimeout(() => {
                alert(`游戏结束！\n\n本局${playerWon ? '获得' : '失去'}：${Math.abs(coinsChange)}金币\n当前金币：${gameState.playerCoins}\n\n游戏统计：\n总局数：${stats.gamesPlayed}\n胜率：${stats.winRate}%\n连胜：${stats.currentWinStreak}`);
            }, 1000);
            
            // 3秒后返回房间
            setTimeout(() => {
                document.getElementById('gameInterface').classList.remove('winning-animation');
                showView('room');
                resetGame();
            }, 4000);
        }

        // 重置游戏
        function resetGame() {
            gameState.gamePhase = 'waiting';
            gameState.currentPlayer = 0;
            gameState.landlord = -1;
            gameState.selectedCards = [];
            gameState.handCards = [];
            gameState.lastPlay = [];
            
            gameState.players.forEach(player => {
                player.cards = 17;
                player.isLandlord = false;
            });
        }

        // 音效控制
        function toggleSound() {
            soundManager.enabled = !soundManager.enabled;
            const soundBtn = document.querySelector('.sound-toggle');
            soundBtn.textContent = soundManager.enabled ? '🔊' : '🔇';
            soundManager.playSound('select');
        }

        // 设置界面
        function showSettings() {
            const stats = gameStats.getStats();
            const settingsInfo = `
🎮 游戏设置

📊 游戏统计：
• 总游戏局数：${stats.gamesPlayed}
• 获胜次数：${stats.gamesWon}
• 胜率：${stats.winRate}%
• 最佳连胜：${stats.bestWinStreak}
• 当前连胜：${stats.currentWinStreak}
• 累计金币：${stats.totalCoinsEarned}

⚙️ 可用设置：
• 音效开关：点击右上角🔊按钮
• 游戏难度：暂未开放
• 界面主题：暂未开放

🎯 操作说明：
• 空格键：出牌
• P键：不出
• H键：提示
• ESC键：返回菜单
• 手机端：左右滑动控制
            `;
            
            alert(settingsInfo);
        }

        // 房间功能扩展
        class RoomManager {
            constructor() {
                this.rooms = new Map();
                this.currentRoom = null;
            }

            createRoom(playerId) {
                const roomId = this.generateRoomId();
                const room = {
                    id: roomId,
                    players: [playerId],
                    maxPlayers: 3,
                    status: 'waiting',
                    gameData: null,
                    created: Date.now()
                };
                
                this.rooms.set(roomId, room);
                this.currentRoom = room;
                return room;
            }

            joinRoom(roomId, playerId) {
                const room = this.rooms.get(roomId);
                if (!room) return null;
                
                if (room.players.length >= room.maxPlayers) {
                    return { error: '房间已满' };
                }
                
                room.players.push(playerId);
                return room;
            }

            generateRoomId() {
                return Math.floor(100000 + Math.random() * 900000).toString();
            }

            leaveRoom(roomId, playerId) {
                const room = this.rooms.get(roomId);
                if (room) {
                    room.players = room.players.filter(id => id !== playerId);
                    if (room.players.length === 0) {
                        this.rooms.delete(roomId);
                    }
                }
            }
        }

        const roomManager = new RoomManager();

        // 增强的卡牌效果
        function addCardEffects() {
            const style = document.createElement('style');
            style.textContent = `
                .card-glow {
                    box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
                    animation: cardGlow 1s ease-in-out infinite alternate;
                }
                
                @keyframes cardGlow {
                    from { box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
                    to { box-shadow: 0 0 30px rgba(255, 215, 0, 1); }
                }
                
                .card-bounce {
                    animation: cardBounce 0.6s ease;
                }
                
                @keyframes cardBounce {
                    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                    40% { transform: translateY(-10px); }
                    60% { transform: translateY(-5px); }
                }
                
                .winning-animation {
                    animation: winCelebration 2s ease-in-out;
                }
                
                @keyframes winCelebration {
                    0% { transform: scale(1) rotate(0deg); }
                    25% { transform: scale(1.1) rotate(5deg); }
                    50% { transform: scale(1.2) rotate(-5deg); }
                    75% { transform: scale(1.1) rotate(3deg); }
                    100% { transform: scale(1) rotate(0deg); }
                }
            `;
            document.head.appendChild(style);
        }

        // 游戏统计 - 使用内存存储
        class GameStats {
            constructor() {
                // 使用内存存储而不是localStorage
                this.data = {
                    gamesPlayed: 0,
                    gamesWon: 0,
                    totalCoinsEarned: 0,
                    bestWinStreak: 0,
                    currentWinStreak: 0
                };
            }

            recordGame(won, coinsChange) {
                this.data.gamesPlayed++;
                if (won) {
                    this.data.gamesWon++;
                    this.data.currentWinStreak++;
                    this.data.bestWinStreak = Math.max(this.data.bestWinStreak, this.data.currentWinStreak);
                } else {
                    this.data.currentWinStreak = 0;
                }
                this.data.totalCoinsEarned += coinsChange;
                console.log('游戏统计已更新:', this.data);
            }

            getWinRate() {
                return this.data.gamesPlayed > 0 ? (this.data.gamesWon / this.data.gamesPlayed * 100).toFixed(1) : 0;
            }

            getStats() {
                return {
                    ...this.data,
                    winRate: this.getWinRate()
                };
            }
        }

        const gameStats = new GameStats();

        // 聊天系统
        class ChatSystem {
            constructor() {
                this.messages = [];
                this.maxMessages = 50;
            }

            addMessage(playerId, message, type = 'normal') {
                const msg = {
                    id: Date.now(),
                    playerId,
                    content: message,
                    type, // normal, system, emoji
                    timestamp: new Date()
                };
                
                this.messages.push(msg);
                if (this.messages.length > this.maxMessages) {
                    this.messages.shift();
                }
                
                this.renderMessages();
            }

            renderMessages() {
                // 聊天界面渲染逻辑
                console.log('聊天消息更新:', this.messages.slice(-5));
            }

            sendQuickMessage(type) {
                const quickMessages = {
                    'good': '👍 好牌！',
                    'bad': '😅 这牌不行',
                    'hurry': '⏰ 快点出牌',
                    'gg': '🎉 精彩对局！'
                };
                
                if (quickMessages[type]) {
                    this.addMessage('我', quickMessages[type], 'emoji');
                }
            }
        }

        const chatSystem = new ChatSystem();

        // 增强AI逻辑
        class AIPlayer {
            constructor(difficulty = 'medium') {
                this.difficulty = difficulty;
                this.handCards = [];
                this.strategies = {
                    easy: { aggression: 0.3, memory: 0.2 },
                    medium: { aggression: 0.6, memory: 0.5 },
                    hard: { aggression: 0.8, memory: 0.8 }
                };
            }

            makeDecision(gameState) {
                const strategy = this.strategies[this.difficulty];
                
                // 根据难度和策略做出决策
                if (Math.random() < strategy.aggression) {
                    return this.aggressivePlay(gameState);
                } else {
                    return this.conservativePlay(gameState);
                }
            }

            aggressivePlay(gameState) {
                // 激进策略：尝试压制对手
                return { action: 'play', cards: [0, 1] };
            }

            conservativePlay(gameState) {
                // 保守策略：稳扎稳打
                return { action: 'play', cards: [0] };
            }

            shouldGrabLandlord(handCards) {
                // 简单的抢地主逻辑
                const strongCards = handCards.filter(card => card.value >= 12).length;
                const jokers = handCards.filter(card => card.isJoker).length;
                
                return (strongCards >= 4 && jokers >= 1) || jokers >= 2;
            }
        }

        // 初始化增强功能
        function initializeEnhancements() {
            addCardEffects();
            
            // 添加键盘支持
            document.addEventListener('keydown', handleKeyPress);
            
            // 添加触摸支持
            if ('ontouchstart' in window) {
                addTouchSupport();
            }
            
            // 加载用户设置
            loadUserSettings();
        }

        // 键盘控制
        function handleKeyPress(event) {
            if (gameState.currentView !== 'game') return;
            
            switch (event.key) {
                case ' ': // 空格键出牌
                    event.preventDefault();
                    playCards();
                    break;
                case 'p': // P键不出
                case 'P':
                    passRound();
                    break;
                case 'h': // H键提示
                case 'H':
                    getHint();
                    break;
                case 'Escape': // ESC键返回
                    backToMenu();
                    break;
            }
        }

        // 触摸支持
        function addTouchSupport() {
            let touchStartX = 0;
            let touchStartY = 0;
            
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                
                // 手势识别
                if (Math.abs(deltaX) > 50 && Math.abs(deltaY) < 30) {
                    if (deltaX > 0) {
                        // 右滑：出牌
                        playCards();
                    } else {
                        // 左滑：不出
                        passRound();
                    }
                }
            });
        }

        // 加载用户设置 - 使用内存存储
        function loadUserSettings() {
            // 使用默认设置，因为无法访问localStorage
            console.log('使用默认游戏设置');
        }

        // 保存用户设置 - 使用内存存储
        function saveUserSettings() {
            console.log('游戏设置已保存到内存');
        }

        // 游戏初始化
        document.addEventListener('DOMContentLoaded', () => {
            initializeEnhancements();
            detectWeChatEnvironment();
            
            console.log('🃏 斗地主游戏已加载完成！');
            console.log('功能特色：');
            console.log('- 精美的视觉效果和动画');
            console.log('- 智能AI对手');
            console.log('- 房间系统支持');
            console.log('- 游戏币系统');
            console.log('- 键盘和触摸控制');
            console.log('- 音效系统');
            console.log('- 微信环境优化');
            console.log('');
            console.log('操作说明：');
            console.log('- 空格键：出牌');
            console.log('- P键：不出');
            console.log('- H键：提示');
            console.log('- ESC键：返回菜单');
            console.log('- 左右滑动：手机端出牌/不出');
            
            // 添加分享按钮到主菜单
            const shareBtn = document.createElement('button');
            shareBtn.className = 'menu-btn secondary';
            shareBtn.textContent = '分享游戏';
            shareBtn.onclick = shareGame;
            document.querySelector('.menu-buttons').appendChild(shareBtn);
        });

        // 页面卸载时保存设置
        window.addEventListener('beforeunload', () => {
            saveUserSettings();
        });

        // 微信环境检测和优化
        function detectWeChatEnvironment() {
            const ua = navigator.userAgent.toLowerCase();
            const isWeChat = ua.indexOf('micromessenger') !== -1;
            
            if (isWeChat) {
                console.log('检测到微信环境，应用微信优化');
                
                // 微信环境优化
                document.body.style.fontFamily = '-apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", STHeiti, "Microsoft Yahei", Tahoma, Simsun, sans-serif';
                
                // 禁用微信分享等功能干扰
                document.addEventListener('WeixinJSBridgeReady', function() {
                    console.log('微信JS Bridge就绪');
                });
                
                // 添加微信专用样式
                const wechatStyle = document.createElement('style');
                wechatStyle.textContent = `
                    body { 
                        -webkit-user-select: none;
                        -webkit-touch-callout: none;
                        -webkit-tap-highlight-color: transparent;
                    }
                    .game-container {
                        -webkit-overflow-scrolling: touch;
                    }
                `;
                document.head.appendChild(wechatStyle);
                
                return true;
            }
            
            return false;
        }

        // 添加分享功能（微信环境下）
        function shareGame() {
            const isWeChat = detectWeChatEnvironment();
            
            if (isWeChat) {
                alert('请点击右上角菜单，选择"发送给朋友"或"分享到朋友圈"来分享这个游戏！');
            } else {
                // 普通浏览器分享
                if (navigator.share) {
                    navigator.share({
                        title: '精美斗地主游戏',
                        text: '来一起玩斗地主吧！',
                        url: window.location.href
                    });
                } else {
                    // 复制链接
                    const tempInput = document.createElement('input');
                    tempInput.value = window.location.href;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    alert('游戏链接已复制到剪贴板！');
                }
            }
        }
    </script>
</body>
</html>