<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–—åœ°ä¸» - ç²¾ç¾ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .game-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" patternUnits="userSpaceOnUse" width="100" height="100"><circle cx="50" cy="50" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }

        /* ä¸»èœå•ç•Œé¢ */
        .main-menu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            z-index: 100;
        }

        .game-title {
            font-size: 4rem;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            margin-bottom: 2rem;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 3px 3px 6px rgba(0,0,0,0.5), 0 0 20px #ffd700; }
            to { text-shadow: 3px 3px 6px rgba(0,0,0,0.5), 0 0 40px #ffd700; }
        }

        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .menu-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .menu-btn.secondary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }

        /* æˆ¿é—´ç•Œé¢ */
        .room-interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 90;
        }

        .room-header {
            height: 80px;
            background: rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            color: white;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .room-id {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .coins-display {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
        }

        .room-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        /* æ¸¸æˆç•Œé¢ */
        .game-interface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        .game-table {
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #2d5a27 0%, #1a3318 100%);
            position: relative;
            border: 8px solid #8b4513;
            border-radius: 20px;
        }

        /* ç©å®¶ä½ç½® */
        .player-area {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-bottom {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        .player-left {
            left: 20px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
        }

        .player-right {
            right: 20px;
            top: 50%;
            transform: translateY(-50%) rotate(90deg);
        }

        .player-info {
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* æ‰‘å…‹ç‰Œæ ·å¼ */
        .card {
            width: 60px;
            height: 80px;
            background: white;
            border-radius: 8px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 -15px;
            font-weight: bold;
        }

        .card:hover {
            transform: translateY(-10px);
        }

        .card.selected {
            transform: translateY(-20px);
            box-shadow: 0 8px 16px rgba(255,215,0,0.6);
        }

        .card.red {
            color: #d32f2f;
        }

        .card.black {
            color: #333;
        }

        .card-back {
            background: linear-gradient(45deg, #1565c0, #0d47a1);
            color: white;
        }

        /* æ‰‹ç‰ŒåŒºåŸŸ */
        .hand-cards {
            display: flex;
            justify-content: center;
            padding: 0 2rem;
        }

        /* å‡ºç‰ŒåŒºåŸŸ */
        .play-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .last-play {
            display: flex;
            gap: 5px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 10px;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .game-controls {
            position: absolute;
            bottom: 120px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-play {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
        }

        .btn-pass {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-hint {
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
        }

        /* æŠ¢åœ°ä¸»ç•Œé¢ */
        .landlord-selection {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            color: white;
            display: none;
        }

        .landlord-btns {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* æ¸¸æˆçŠ¶æ€æ˜¾ç¤º */
        .game-status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .game-title {
                font-size: 2.5rem;
            }
            
            .card {
                width: 45px;
                height: 60px;
                font-size: 0.8rem;
            }
            
            .player-info {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes cardDeal {
            from {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .card-enter {
            animation: cardDeal 0.5s ease-out;
        }

        /* éŸ³æ•ˆæ§åˆ¶ */
        .sound-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
            gap: 10px;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <button class="sound-toggle" onclick="toggleSound()">ğŸ”Š</button>
        
        <!-- ä¸»èœå• -->
        <div class="main-menu" id="mainMenu">
            <h1 class="game-title">ğŸƒ æ–—åœ°ä¸»</h1>
            <div class="menu-buttons">
                <button class="menu-btn" onclick="createRoom()">åˆ›å»ºæˆ¿é—´</button>
                <button class="menu-btn secondary" onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
                <button class="menu-btn secondary" onclick="showSettings()">è®¾ç½®</button>
            </div>
        </div>

        <!-- æˆ¿é—´ç•Œé¢ -->
        <div class="room-interface" id="roomInterface">
            <div class="room-header">
                <div class="room-info">
                    <div class="room-id">æˆ¿é—´å·: <span id="roomId">888888</span></div>
                    <div class="coins-display">ğŸ’° <span id="playerCoins">1000</span></div>
                </div>
                <button class="menu-btn" onclick="backToMenu()">è¿”å›å¤§å…</button>
            </div>
            <div class="room-content">
                <div class="loading" id="waitingPlayers">
                    <div class="spinner"></div>
                    ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥...
                </div>
                <button class="menu-btn" onclick="startGame()" id="startGameBtn" style="display: none;">å¼€å§‹æ¸¸æˆ</button>
            </div>
        </div>

        <!-- æ¸¸æˆç•Œé¢ -->
        <div class="game-interface" id="gameInterface">
            <div class="game-table">
                <div class="game-status" id="gameStatus">ç­‰å¾…æ¸¸æˆå¼€å§‹...</div>
                
                <!-- ç©å®¶åŒºåŸŸ -->
                <div class="player-area player-left" id="leftPlayer">
                    <div class="player-info">
                        <div class="player-avatar">ğŸ‘¤</div>
                        <span>ç©å®¶2</span>
                        <span class="card-count">(17å¼ )</span>
                    </div>
                </div>
                
                <div class="player-area player-right" id="rightPlayer">
                    <div class="player-info">
                        <div class="player-avatar">ğŸ‘¤</div>
                        <span>ç©å®¶3</span>
                        <span class="card-count">(17å¼ )</span>
                    </div>
                </div>
                
                <div class="player-area player-bottom" id="bottomPlayer">
                    <div class="player-info">
                        <div class="player-avatar">ğŸ‘¤</div>
                        <span>æˆ‘</span>
                        <span class="card-count">(17å¼ )</span>
                    </div>
                </div>

                <!-- å‡ºç‰ŒåŒºåŸŸ -->
                <div class="play-area" id="playArea">
                    <div class="last-play" id="lastPlay">
                        <!-- æœ€åå‡ºçš„ç‰Œ -->
                    </div>
                </div>

                <!-- æ‰‹ç‰ŒåŒºåŸŸ -->
                <div class="hand-cards" id="handCards">
                    <!-- ç©å®¶æ‰‹ç‰Œ -->
                </div>

                <!-- æ¸¸æˆæ§åˆ¶æŒ‰é’® -->
                <div class="game-controls">
                    <button class="control-btn btn-hint" onclick="getHint()">æç¤º</button>
                    <button class="control-btn btn-pass" onclick="passRound()">ä¸å‡º</button>
                    <button class="control-btn btn-play" onclick="playCards()">å‡ºç‰Œ</button>
                </div>
            </div>
        </div>

        <!-- æŠ¢åœ°ä¸»ç•Œé¢ -->
        <div class="landlord-selection" id="landlordSelection">
            <h3>æŠ¢åœ°ä¸»</h3>
            <p>æ˜¯å¦è¦æŠ¢åœ°ä¸»ï¼Ÿ</p>
            <div class="landlord-btns">
                <button class="control-btn btn-play" onclick="grabLandlord(true)">æŠ¢åœ°ä¸»</button>
                <button class="control-btn btn-pass" onclick="grabLandlord(false)">ä¸æŠ¢</button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€ç®¡ç†
        class GameState {
            constructor() {
                this.currentView = 'menu';
                this.roomId = '';
                this.playerCoins = 1000;
                this.soundEnabled = true;
                this.gamePhase = 'waiting'; // waiting, bidding, playing, ended
                this.currentPlayer = 0;
                this.landlord = -1;
                this.selectedCards = [];
                this.handCards = [];
                this.lastPlay = [];
                this.players = [
                    { name: 'æˆ‘', cards: 17, avatar: 'ğŸ‘¤', isLandlord: false },
                    { name: 'ç©å®¶2', cards: 17, avatar: 'ğŸ‘¤', isLandlord: false },
                    { name: 'ç©å®¶3', cards: 17, avatar: 'ğŸ‘¤', isLandlord: false }
                ];
            }
        }

        const gameState = new GameState();

        // æ‰‘å…‹ç‰Œæ•°æ®
        const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const RANKS = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2'];
        const JOKERS = ['å°ç‹', 'å¤§ç‹'];

        // éŸ³æ•ˆç³»ç»Ÿ
        class SoundManager {
            constructor() {
                this.enabled = true;
                this.audioContext = null;
                this.sounds = {};
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('éŸ³é¢‘ä¸æ”¯æŒ');
                }
            }

            playSound(type) {
                if (!this.enabled || !this.audioContext) return;
                
                // ç®€å•çš„éŸ³æ•ˆç”Ÿæˆ
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                const frequencies = {
                    'card': 800,
                    'select': 600,
                    'play': 1000,
                    'win': 1200,
                    'error': 300
                };
                
                oscillator.frequency.setValueAtTime(frequencies[type] || 500, this.audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.2);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + 0.2);
            }
        }

        const soundManager = new SoundManager();

        // æ‰‘å…‹ç‰Œç”Ÿæˆ
        function generateDeck() {
            const deck = [];
            
            // ç”Ÿæˆæ™®é€šç‰Œ
            for (let suit of SUITS) {
                for (let rank of RANKS) {
                    deck.push({
                        suit,
                        rank,
                        value: RANKS.indexOf(rank) + 3,
                        display: rank + suit,
                        isRed: suit === 'â™¥' || suit === 'â™¦'
                    });
                }
            }
            
            // æ·»åŠ å¤§å°ç‹
            deck.push({
                suit: '',
                rank: 'å°ç‹',
                value: 16,
                display: 'ğŸƒ',
                isRed: false,
                isJoker: true
            });
            
            deck.push({
                suit: '',
                rank: 'å¤§ç‹',
                value: 17,
                display: 'ğŸ‚¿',
                isRed: true,
                isJoker: true
            });
            
            return deck;
        }

        // æ´—ç‰Œç®—æ³•
        function shuffleDeck(deck) {
            const shuffled = [...deck];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // ç•Œé¢åˆ‡æ¢
        function showView(viewName) {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('roomInterface').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'none';
            
            switch (viewName) {
                case 'menu':
                    document.getElementById('mainMenu').style.display = 'flex';
                    break;
                case 'room':
                    document.getElementById('roomInterface').style.display = 'block';
                    break;
                case 'game':
                    document.getElementById('gameInterface').style.display = 'block';
                    break;
            }
            
            gameState.currentView = viewName;
        }

        // åˆ›å»ºæˆ¿é—´
        function createRoom() {
            gameState.roomId = Math.floor(100000 + Math.random() * 900000).toString();
            document.getElementById('roomId').textContent = gameState.roomId;
            document.getElementById('playerCoins').textContent = gameState.playerCoins;
            
            showView('room');
            soundManager.playSound('select');
            
            // æ¨¡æ‹Ÿå…¶ä»–ç©å®¶åŠ å…¥
            setTimeout(() => {
                document.getElementById('waitingPlayers').style.display = 'none';
                document.getElementById('startGameBtn').style.display = 'block';
            }, 2000);
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            const roomId = prompt('è¯·è¾“å…¥æˆ¿é—´å·:');
            if (roomId && roomId.length === 6) {
                gameState.roomId = roomId;
                document.getElementById('roomId').textContent = roomId;
                createRoom(); // ç®€åŒ–å¤„ç†ï¼Œç›´æ¥è¿›å…¥æˆ¿é—´
            } else {
                alert('æˆ¿é—´å·æ ¼å¼ä¸æ­£ç¡®ï¼');
            }
        }

        // å¼€å§‹æ¸¸æˆ
        function startGame() {
            showView('game');
            soundManager.playSound('play');
            initializeGame();
        }

        // è¿”å›ä¸»èœå•
        function backToMenu() {
            showView('menu');
            soundManager.playSound('select');
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initializeGame() {
            const deck = shuffleDeck(generateDeck());
            
            // å‘ç‰Œ
            gameState.handCards = deck.slice(0, 17);
            gameState.handCards.sort((a, b) => a.value - b.value);
            
            renderHandCards();
            updateGameStatus('è¯·é€‰æ‹©æ˜¯å¦æŠ¢åœ°ä¸»');
            
            // æ˜¾ç¤ºæŠ¢åœ°ä¸»ç•Œé¢
            setTimeout(() => {
                document.getElementById('landlordSelection').style.display = 'block';
            }, 1000);
        }

        // æ¸²æŸ“æ‰‹ç‰Œ
        function renderHandCards() {
            const handCardsEl = document.getElementById('handCards');
            handCardsEl.innerHTML = '';
            
            gameState.handCards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${card.isRed ? 'red' : 'black'} card-enter`;
                cardEl.textContent = card.display;
                cardEl.style.animationDelay = `${index * 0.05}s`;
                cardEl.onclick = () => selectCard(index);
                handCardsEl.appendChild(cardEl);
            });
        }

        // é€‰æ‹©å¡ç‰Œ
        function selectCard(index) {
            const cardIndex = gameState.selectedCards.indexOf(index);
            const cardEl = document.getElementById('handCards').children[index];
            
            if (cardIndex > -1) {
                gameState.selectedCards.splice(cardIndex, 1);
                cardEl.classList.remove('selected');
            } else {
                gameState.selectedCards.push(index);
                cardEl.classList.add('selected');
            }
            
            soundManager.playSound('select');
        }

        // æŠ¢åœ°ä¸»
        function grabLandlord(grab) {
            document.getElementById('landlordSelection').style.display = 'none';
            
            if (grab) {
                gameState.landlord = 0;
                gameState.players[0].isLandlord = true;
                updateGameStatus('ä½ æ˜¯åœ°ä¸»ï¼');
                soundManager.playSound('win');
            } else {
                // éšæœºåˆ†é…åœ°ä¸»
                gameState.landlord = Math.floor(Math.random() * 3);
                gameState.players[gameState.landlord].isLandlord = true;
                updateGameStatus(`${gameState.players[gameState.landlord].name}æ˜¯åœ°ä¸»ï¼`);
            }
            
            gameState.gamePhase = 'playing';
            gameState.currentPlayer = gameState.landlord;
            
            setTimeout(() => {
                updateGameStatus('æ¸¸æˆå¼€å§‹ï¼è½®åˆ°ä½ å‡ºç‰Œ');
            }, 2000);
        }

        // å‡ºç‰Œ
        function playCards() {
            if (gameState.selectedCards.length === 0) {
                alert('è¯·é€‰æ‹©è¦å‡ºçš„ç‰Œï¼');
                return;
            }
            
            const selectedCards = gameState.selectedCards.map(i => gameState.handCards[i]);
            
            if (isValidPlay(selectedCards)) {
                // ä»æ‰‹ç‰Œä¸­ç§»é™¤é€‰ä¸­çš„ç‰Œ
                gameState.selectedCards.sort((a, b) => b - a);
                gameState.selectedCards.forEach(index => {
                    gameState.handCards.splice(index, 1);
                });
                
                gameState.selectedCards = [];
                gameState.lastPlay = selectedCards;
                
                renderHandCards();
                renderLastPlay();
                soundManager.playSound('play');
                
                // æ£€æŸ¥æ¸¸æˆç»“æŸ
                if (gameState.handCards.length === 0) {
                    endGame(true);
                    return;
                }
                
                // ä¸‹ä¸€ä¸ªç©å®¶
                nextPlayer();
            } else {
                alert('å‡ºç‰Œä¸ç¬¦åˆè§„åˆ™ï¼');
                soundManager.playSound('error');
            }
        }

        // ä¸å‡º
        function passRound() {
            gameState.selectedCards = [];
            renderHandCards();
            nextPlayer();
            soundManager.playSound('select');
        }

        // è·å–æç¤º
        function getHint() {
            // ç®€å•çš„æç¤ºé€»è¾‘
            if (gameState.handCards.length > 0) {
                gameState.selectedCards = [0];
                renderHandCards();
                document.getElementById('handCards').children[0].classList.add('selected');
                soundManager.playSound('select');
            }
        }

        // éªŒè¯å‡ºç‰Œæ˜¯å¦æœ‰æ•ˆ
        function isValidPlay(cards) {
            if (cards.length === 0) return false;
            
            // ç®€åŒ–éªŒè¯ï¼šå•å¼ ã€å¯¹å­ã€ä¸‰å¼ éƒ½ç®—æœ‰æ•ˆ
            if (cards.length === 1) return true;
            if (cards.length === 2) {
                return cards[0].value === cards[1].value;
            }
            if (cards.length === 3) {
                return cards[0].value === cards[1].value && cards[1].value === cards[2].value;
            }
            
            return true; // å…¶ä»–ç‰Œå‹æš‚æ—¶éƒ½è®¤ä¸ºæœ‰æ•ˆ
        }

        // æ¸²æŸ“æœ€åå‡ºçš„ç‰Œ
        function renderLastPlay() {
            const lastPlayEl = document.getElementById('lastPlay');
            lastPlayEl.innerHTML = '';
            
            gameState.lastPlay.forEach(card => {
                const cardEl = document.createElement('div');
                cardEl.className = `card ${card.isRed ? 'red' : 'black'}`;
                cardEl.textContent = card.display;
                cardEl.style.margin = '0 2px';
                lastPlayEl.appendChild(cardEl);
            });
        }

        // ä¸‹ä¸€ä¸ªç©å®¶
        function nextPlayer() {
            gameState.currentPlayer = (gameState.currentPlayer + 1) % 3;
            
            if (gameState.currentPlayer === 0) {
                updateGameStatus('è½®åˆ°ä½ å‡ºç‰Œ');
            } else {
                updateGameStatus(`è½®åˆ°${gameState.players[gameState.currentPlayer].name}å‡ºç‰Œ`);
                
                // AIç©å®¶è‡ªåŠ¨å‡ºç‰Œ
                setTimeout(() => {
                    aiPlay();
                }, 1500);
            }
        }

        // AIç©å®¶å‡ºç‰Œ - æ”¹è¿›é€»è¾‘
        function aiPlay() {
            // æ›´æ™ºèƒ½çš„AIå‡ºç‰Œé€»è¾‘
            const shouldPlay = Math.random() > 0.3; // 70%æ¦‚ç‡å‡ºç‰Œ
            
            if (!shouldPlay && gameState.lastPlay.length > 0) {
                // AIé€‰æ‹©ä¸å‡º
                updateGameStatus(`${gameState.players[gameState.currentPlayer].name}é€‰æ‹©ä¸å‡º`);
                nextPlayer();
                return;
            }
            
            // éšæœºé€‰æ‹©å‡ºç‰Œæ•°é‡
            const aiCards = Math.floor(Math.random() * 3) + 1;
            
            // æ¨¡æ‹ŸAIå‡ºç‰Œ
            const playedCards = [];
            const cardTypes = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
            const cardValues = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2'];
            
            for (let i = 0; i < aiCards; i++) {
                const randomSuit = cardTypes[Math.floor(Math.random() * cardTypes.length)];
                const randomValue = cardValues[Math.floor(Math.random() * cardValues.length)];
                playedCards.push({
                    suit: randomSuit,
                    rank: randomValue,
                    value: cardValues.indexOf(randomValue) + 3,
                    display: randomValue + randomSuit,
                    isRed: randomSuit === 'â™¥' || randomSuit === 'â™¦'
                });
            }
            
            gameState.lastPlay = playedCards;
            gameState.players[gameState.currentPlayer].cards -= aiCards;
            
            renderLastPlay();
            updatePlayerCardCount();
            updateGameStatus(`${gameState.players[gameState.currentPlayer].name}å‡ºäº†${aiCards}å¼ ç‰Œ`);
            
            // æ£€æŸ¥AIæ˜¯å¦è·èƒœ
            if (gameState.players[gameState.currentPlayer].cards === 0) {
                endGame(false);
                return;
            }
            
            // å»¶è¿Ÿåä¸‹ä¸€ä¸ªç©å®¶
            setTimeout(() => {
                nextPlayer();
            }, 1000);
        }

        // æ›´æ–°ç©å®¶å¡ç‰Œæ•°é‡æ˜¾ç¤º
        function updatePlayerCardCount() {
            const cardCounts = document.querySelectorAll('.card-count');
            cardCounts.forEach((el, index) => {
                el.textContent = `(${gameState.players[index].cards}å¼ )`;
            });
        }

        // æ›´æ–°æ¸¸æˆçŠ¶æ€
        function updateGameStatus(status) {
            document.getElementById('gameStatus').textContent = status;
        }

        // ç»“æŸæ¸¸æˆ
        function endGame(playerWon) {
            let coinsChange = 0;
            
            if (playerWon) {
                updateGameStatus('ğŸ‰ æ­å–œä½ è·èƒœï¼');
                coinsChange = 100;
                gameState.playerCoins += coinsChange;
                soundManager.playSound('win');
                
                // æ·»åŠ è·èƒœåŠ¨ç”»
                document.getElementById('gameInterface').classList.add('winning-animation');
            } else {
                updateGameStatus('ğŸ˜” æ¸¸æˆç»“æŸï¼');
                coinsChange = -50;
                gameState.playerCoins -= 50;
                soundManager.playSound('error');
            }
            
            // æ›´æ–°ç»Ÿè®¡
            gameStats.recordGame(playerWon, coinsChange);
            
            // æ›´æ–°æ˜¾ç¤ºçš„é‡‘å¸æ•°é‡
            document.getElementById('playerCoins').textContent = gameState.playerCoins;
            
            // æ˜¾ç¤ºæ¸¸æˆç»Ÿè®¡
            const stats = gameStats.getStats();
            setTimeout(() => {
                alert(`æ¸¸æˆç»“æŸï¼\n\næœ¬å±€${playerWon ? 'è·å¾—' : 'å¤±å»'}ï¼š${Math.abs(coinsChange)}é‡‘å¸\nå½“å‰é‡‘å¸ï¼š${gameState.playerCoins}\n\næ¸¸æˆç»Ÿè®¡ï¼š\næ€»å±€æ•°ï¼š${stats.gamesPlayed}\nèƒœç‡ï¼š${stats.winRate}%\nè¿èƒœï¼š${stats.currentWinStreak}`);
            }, 1000);
            
            // 3ç§’åè¿”å›æˆ¿é—´
            setTimeout(() => {
                document.getElementById('gameInterface').classList.remove('winning-animation');
                showView('room');
                resetGame();
            }, 4000);
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            gameState.gamePhase = 'waiting';
            gameState.currentPlayer = 0;
            gameState.landlord = -1;
            gameState.selectedCards = [];
            gameState.handCards = [];
            gameState.lastPlay = [];
            
            gameState.players.forEach(player => {
                player.cards = 17;
                player.isLandlord = false;
            });
        }

        // éŸ³æ•ˆæ§åˆ¶
        function toggleSound() {
            soundManager.enabled = !soundManager.enabled;
            const soundBtn = document.querySelector('.sound-toggle');
            soundBtn.textContent = soundManager.enabled ? 'ğŸ”Š' : 'ğŸ”‡';
            soundManager.playSound('select');
        }

        // è®¾ç½®ç•Œé¢
        function showSettings() {
            const stats = gameStats.getStats();
            const settingsInfo = `
ğŸ® æ¸¸æˆè®¾ç½®

ğŸ“Š æ¸¸æˆç»Ÿè®¡ï¼š
â€¢ æ€»æ¸¸æˆå±€æ•°ï¼š${stats.gamesPlayed}
â€¢ è·èƒœæ¬¡æ•°ï¼š${stats.gamesWon}
â€¢ èƒœç‡ï¼š${stats.winRate}%
â€¢ æœ€ä½³è¿èƒœï¼š${stats.bestWinStreak}
â€¢ å½“å‰è¿èƒœï¼š${stats.currentWinStreak}
â€¢ ç´¯è®¡é‡‘å¸ï¼š${stats.totalCoinsEarned}

âš™ï¸ å¯ç”¨è®¾ç½®ï¼š
â€¢ éŸ³æ•ˆå¼€å…³ï¼šç‚¹å‡»å³ä¸Šè§’ğŸ”ŠæŒ‰é’®
â€¢ æ¸¸æˆéš¾åº¦ï¼šæš‚æœªå¼€æ”¾
â€¢ ç•Œé¢ä¸»é¢˜ï¼šæš‚æœªå¼€æ”¾

ğŸ¯ æ“ä½œè¯´æ˜ï¼š
â€¢ ç©ºæ ¼é”®ï¼šå‡ºç‰Œ
â€¢ Pé”®ï¼šä¸å‡º
â€¢ Hé”®ï¼šæç¤º
â€¢ ESCé”®ï¼šè¿”å›èœå•
â€¢ æ‰‹æœºç«¯ï¼šå·¦å³æ»‘åŠ¨æ§åˆ¶
            `;
            
            alert(settingsInfo);
        }

        // æˆ¿é—´åŠŸèƒ½æ‰©å±•
        class RoomManager {
            constructor() {
                this.rooms = new Map();
                this.currentRoom = null;
            }

            createRoom(playerId) {
                const roomId = this.generateRoomId();
                const room = {
                    id: roomId,
                    players: [playerId],
                    maxPlayers: 3,
                    status: 'waiting',
                    gameData: null,
                    created: Date.now()
                };
                
                this.rooms.set(roomId, room);
                this.currentRoom = room;
                return room;
            }

            joinRoom(roomId, playerId) {
                const room = this.rooms.get(roomId);
                if (!room) return null;
                
                if (room.players.length >= room.maxPlayers) {
                    return { error: 'æˆ¿é—´å·²æ»¡' };
                }
                
                room.players.push(playerId);
                return room;
            }

            generateRoomId() {
                return Math.floor(100000 + Math.random() * 900000).toString();
            }

            leaveRoom(roomId, playerId) {
                const room = this.rooms.get(roomId);
                if (room) {
                    room.players = room.players.filter(id => id !== playerId);
                    if (room.players.length === 0) {
                        this.rooms.delete(roomId);
                    }
                }
            }
        }

        const roomManager = new RoomManager();

        // å¢å¼ºçš„å¡ç‰Œæ•ˆæœ
        function addCardEffects() {
            const style = document.createElement('style');
            style.textContent = `
                .card-glow {
                    box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
                    animation: cardGlow 1s ease-in-out infinite alternate;
                }
                
                @keyframes cardGlow {
                    from { box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
                    to { box-shadow: 0 0 30px rgba(255, 215, 0, 1); }
                }
                
                .card-bounce {
                    animation: cardBounce 0.6s ease;
                }
                
                @keyframes cardBounce {
                    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                    40% { transform: translateY(-10px); }
                    60% { transform: translateY(-5px); }
                }
                
                .winning-animation {
                    animation: winCelebration 2s ease-in-out;
                }
                
                @keyframes winCelebration {
                    0% { transform: scale(1) rotate(0deg); }
                    25% { transform: scale(1.1) rotate(5deg); }
                    50% { transform: scale(1.2) rotate(-5deg); }
                    75% { transform: scale(1.1) rotate(3deg); }
                    100% { transform: scale(1) rotate(0deg); }
                }
            `;
            document.head.appendChild(style);
        }

        // æ¸¸æˆç»Ÿè®¡ - ä½¿ç”¨å†…å­˜å­˜å‚¨
        class GameStats {
            constructor() {
                // ä½¿ç”¨å†…å­˜å­˜å‚¨è€Œä¸æ˜¯localStorage
                this.data = {
                    gamesPlayed: 0,
                    gamesWon: 0,
                    totalCoinsEarned: 0,
                    bestWinStreak: 0,
                    currentWinStreak: 0
                };
            }

            recordGame(won, coinsChange) {
                this.data.gamesPlayed++;
                if (won) {
                    this.data.gamesWon++;
                    this.data.currentWinStreak++;
                    this.data.bestWinStreak = Math.max(this.data.bestWinStreak, this.data.currentWinStreak);
                } else {
                    this.data.currentWinStreak = 0;
                }
                this.data.totalCoinsEarned += coinsChange;
                console.log('æ¸¸æˆç»Ÿè®¡å·²æ›´æ–°:', this.data);
            }

            getWinRate() {
                return this.data.gamesPlayed > 0 ? (this.data.gamesWon / this.data.gamesPlayed * 100).toFixed(1) : 0;
            }

            getStats() {
                return {
                    ...this.data,
                    winRate: this.getWinRate()
                };
            }
        }

        const gameStats = new GameStats();

        // èŠå¤©ç³»ç»Ÿ
        class ChatSystem {
            constructor() {
                this.messages = [];
                this.maxMessages = 50;
            }

            addMessage(playerId, message, type = 'normal') {
                const msg = {
                    id: Date.now(),
                    playerId,
                    content: message,
                    type, // normal, system, emoji
                    timestamp: new Date()
                };
                
                this.messages.push(msg);
                if (this.messages.length > this.maxMessages) {
                    this.messages.shift();
                }
                
                this.renderMessages();
            }

            renderMessages() {
                // èŠå¤©ç•Œé¢æ¸²æŸ“é€»è¾‘
                console.log('èŠå¤©æ¶ˆæ¯æ›´æ–°:', this.messages.slice(-5));
            }

            sendQuickMessage(type) {
                const quickMessages = {
                    'good': 'ğŸ‘ å¥½ç‰Œï¼',
                    'bad': 'ğŸ˜… è¿™ç‰Œä¸è¡Œ',
                    'hurry': 'â° å¿«ç‚¹å‡ºç‰Œ',
                    'gg': 'ğŸ‰ ç²¾å½©å¯¹å±€ï¼'
                };
                
                if (quickMessages[type]) {
                    this.addMessage('æˆ‘', quickMessages[type], 'emoji');
                }
            }
        }

        const chatSystem = new ChatSystem();

        // å¢å¼ºAIé€»è¾‘
        class AIPlayer {
            constructor(difficulty = 'medium') {
                this.difficulty = difficulty;
                this.handCards = [];
                this.strategies = {
                    easy: { aggression: 0.3, memory: 0.2 },
                    medium: { aggression: 0.6, memory: 0.5 },
                    hard: { aggression: 0.8, memory: 0.8 }
                };
            }

            makeDecision(gameState) {
                const strategy = this.strategies[this.difficulty];
                
                // æ ¹æ®éš¾åº¦å’Œç­–ç•¥åšå‡ºå†³ç­–
                if (Math.random() < strategy.aggression) {
                    return this.aggressivePlay(gameState);
                } else {
                    return this.conservativePlay(gameState);
                }
            }

            aggressivePlay(gameState) {
                // æ¿€è¿›ç­–ç•¥ï¼šå°è¯•å‹åˆ¶å¯¹æ‰‹
                return { action: 'play', cards: [0, 1] };
            }

            conservativePlay(gameState) {
                // ä¿å®ˆç­–ç•¥ï¼šç¨³æ‰ç¨³æ‰“
                return { action: 'play', cards: [0] };
            }

            shouldGrabLandlord(handCards) {
                // ç®€å•çš„æŠ¢åœ°ä¸»é€»è¾‘
                const strongCards = handCards.filter(card => card.value >= 12).length;
                const jokers = handCards.filter(card => card.isJoker).length;
                
                return (strongCards >= 4 && jokers >= 1) || jokers >= 2;
            }
        }

        // åˆå§‹åŒ–å¢å¼ºåŠŸèƒ½
        function initializeEnhancements() {
            addCardEffects();
            
            // æ·»åŠ é”®ç›˜æ”¯æŒ
            document.addEventListener('keydown', handleKeyPress);
            
            // æ·»åŠ è§¦æ‘¸æ”¯æŒ
            if ('ontouchstart' in window) {
                addTouchSupport();
            }
            
            // åŠ è½½ç”¨æˆ·è®¾ç½®
            loadUserSettings();
        }

        // é”®ç›˜æ§åˆ¶
        function handleKeyPress(event) {
            if (gameState.currentView !== 'game') return;
            
            switch (event.key) {
                case ' ': // ç©ºæ ¼é”®å‡ºç‰Œ
                    event.preventDefault();
                    playCards();
                    break;
                case 'p': // Pé”®ä¸å‡º
                case 'P':
                    passRound();
                    break;
                case 'h': // Hé”®æç¤º
                case 'H':
                    getHint();
                    break;
                case 'Escape': // ESCé”®è¿”å›
                    backToMenu();
                    break;
            }
        }

        // è§¦æ‘¸æ”¯æŒ
        function addTouchSupport() {
            let touchStartX = 0;
            let touchStartY = 0;
            
            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });
            
            document.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                
                // æ‰‹åŠ¿è¯†åˆ«
                if (Math.abs(deltaX) > 50 && Math.abs(deltaY) < 30) {
                    if (deltaX > 0) {
                        // å³æ»‘ï¼šå‡ºç‰Œ
                        playCards();
                    } else {
                        // å·¦æ»‘ï¼šä¸å‡º
                        passRound();
                    }
                }
            });
        }

        // åŠ è½½ç”¨æˆ·è®¾ç½® - ä½¿ç”¨å†…å­˜å­˜å‚¨
        function loadUserSettings() {
            // ä½¿ç”¨é»˜è®¤è®¾ç½®ï¼Œå› ä¸ºæ— æ³•è®¿é—®localStorage
            console.log('ä½¿ç”¨é»˜è®¤æ¸¸æˆè®¾ç½®');
        }

        // ä¿å­˜ç”¨æˆ·è®¾ç½® - ä½¿ç”¨å†…å­˜å­˜å‚¨
        function saveUserSettings() {
            console.log('æ¸¸æˆè®¾ç½®å·²ä¿å­˜åˆ°å†…å­˜');
        }

        // æ¸¸æˆåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeEnhancements();
            detectWeChatEnvironment();
            
            console.log('ğŸƒ æ–—åœ°ä¸»æ¸¸æˆå·²åŠ è½½å®Œæˆï¼');
            console.log('åŠŸèƒ½ç‰¹è‰²ï¼š');
            console.log('- ç²¾ç¾çš„è§†è§‰æ•ˆæœå’ŒåŠ¨ç”»');
            console.log('- æ™ºèƒ½AIå¯¹æ‰‹');
            console.log('- æˆ¿é—´ç³»ç»Ÿæ”¯æŒ');
            console.log('- æ¸¸æˆå¸ç³»ç»Ÿ');
            console.log('- é”®ç›˜å’Œè§¦æ‘¸æ§åˆ¶');
            console.log('- éŸ³æ•ˆç³»ç»Ÿ');
            console.log('- å¾®ä¿¡ç¯å¢ƒä¼˜åŒ–');
            console.log('');
            console.log('æ“ä½œè¯´æ˜ï¼š');
            console.log('- ç©ºæ ¼é”®ï¼šå‡ºç‰Œ');
            console.log('- Pé”®ï¼šä¸å‡º');
            console.log('- Hé”®ï¼šæç¤º');
            console.log('- ESCé”®ï¼šè¿”å›èœå•');
            console.log('- å·¦å³æ»‘åŠ¨ï¼šæ‰‹æœºç«¯å‡ºç‰Œ/ä¸å‡º');
            
            // æ·»åŠ åˆ†äº«æŒ‰é’®åˆ°ä¸»èœå•
            const shareBtn = document.createElement('button');
            shareBtn.className = 'menu-btn secondary';
            shareBtn.textContent = 'åˆ†äº«æ¸¸æˆ';
            shareBtn.onclick = shareGame;
            document.querySelector('.menu-buttons').appendChild(shareBtn);
        });

        // é¡µé¢å¸è½½æ—¶ä¿å­˜è®¾ç½®
        window.addEventListener('beforeunload', () => {
            saveUserSettings();
        });

        // å¾®ä¿¡ç¯å¢ƒæ£€æµ‹å’Œä¼˜åŒ–
        function detectWeChatEnvironment() {
            const ua = navigator.userAgent.toLowerCase();
            const isWeChat = ua.indexOf('micromessenger') !== -1;
            
            if (isWeChat) {
                console.log('æ£€æµ‹åˆ°å¾®ä¿¡ç¯å¢ƒï¼Œåº”ç”¨å¾®ä¿¡ä¼˜åŒ–');
                
                // å¾®ä¿¡ç¯å¢ƒä¼˜åŒ–
                document.body.style.fontFamily = '-apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", STHeiti, "Microsoft Yahei", Tahoma, Simsun, sans-serif';
                
                // ç¦ç”¨å¾®ä¿¡åˆ†äº«ç­‰åŠŸèƒ½å¹²æ‰°
                document.addEventListener('WeixinJSBridgeReady', function() {
                    console.log('å¾®ä¿¡JS Bridgeå°±ç»ª');
                });
                
                // æ·»åŠ å¾®ä¿¡ä¸“ç”¨æ ·å¼
                const wechatStyle = document.createElement('style');
                wechatStyle.textContent = `
                    body { 
                        -webkit-user-select: none;
                        -webkit-touch-callout: none;
                        -webkit-tap-highlight-color: transparent;
                    }
                    .game-container {
                        -webkit-overflow-scrolling: touch;
                    }
                `;
                document.head.appendChild(wechatStyle);
                
                return true;
            }
            
            return false;
        }

        // æ·»åŠ åˆ†äº«åŠŸèƒ½ï¼ˆå¾®ä¿¡ç¯å¢ƒä¸‹ï¼‰
        function shareGame() {
            const isWeChat = detectWeChatEnvironment();
            
            if (isWeChat) {
                alert('è¯·ç‚¹å‡»å³ä¸Šè§’èœå•ï¼Œé€‰æ‹©"å‘é€ç»™æœ‹å‹"æˆ–"åˆ†äº«åˆ°æœ‹å‹åœˆ"æ¥åˆ†äº«è¿™ä¸ªæ¸¸æˆï¼');
            } else {
                // æ™®é€šæµè§ˆå™¨åˆ†äº«
                if (navigator.share) {
                    navigator.share({
                        title: 'ç²¾ç¾æ–—åœ°ä¸»æ¸¸æˆ',
                        text: 'æ¥ä¸€èµ·ç©æ–—åœ°ä¸»å§ï¼',
                        url: window.location.href
                    });
                } else {
                    // å¤åˆ¶é“¾æ¥
                    const tempInput = document.createElement('input');
                    tempInput.value = window.location.href;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    alert('æ¸¸æˆé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }
            }
        }
    </script>
</body>
</html>