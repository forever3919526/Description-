<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¤§é±¼åƒå°é±¼ - æµ·æ´‹è¿›åŒ–</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
            user-select: none;
        }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            background: linear-gradient(to bottom, #1a2980, #26d0ce);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        #gameContainer {
            position: relative;
            width: 100%;
            max-width: 500px;
            height: 80vh;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 100, 0.5);
            border-radius: 15px;
            background: #0a1f44;
            border: 3px solid #3a86ff;
        }
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #uiLayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: rgba(10, 31, 68, 0.92);
            z-index: 30;
            padding: 20px;
            transition: opacity 0.5s;
            backdrop-filter: blur(5px);
        }
        .hidden {
            opacity: 0;
            pointer-events: none;
        }
        .title {
            font-size: 2.8rem;
            margin-bottom: 15px;
            color: #4df3ff;
            text-shadow: 0 0 15px #00f7ff, 0 0 5px #3a86ff;
            letter-spacing: 2px;
            font-weight: bold;
            background: linear-gradient(to right, #ff9a9e, #fad0c4, #a1c4fd, #c2e9fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 {
            font-size: 2.2rem;
            margin-bottom: 25px;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
        }
        p {
            font-size: 1.15rem;
            margin: 12px 0;
            max-width: 85%;
            line-height: 1.6;
            color: #e6f7ff;
        }
        .btn {
            margin-top: 30px;
            padding: 14px 45px;
            font-size: 1.2rem;
            background: linear-gradient(to right, #ff8c00, #ff0080);
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            pointer-events: auto;
            box-shadow: 0 6æ 20px rgba(255, 0, 128, 0.5);
            transition: all 0.3s;
            font-weight: bold;
            z-index: 40;
            position: relative;
            overflow: hidden;
        }
        .btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -60%;
            width: 20px;
            height: 200%;
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(25deg);
            transition: all 0.4s;
        }
        .btn:hover::after {
            left: 120%;
        }
        .btn:active {
            transform: translateY(3px);
            box-shadow: 0 3px 10px rgba(255, 0, 128, 0.5);
        }
        #scoreDisplay {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.5rem;
            color: #ffcc00;
            font-weight: bold;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
            z-index: 25;
            background: rgba(0, 20, 50, 0.7);
            padding: 8px 15px;
            border-radius: 30px;
            border: 2px solid #ffcc00;
        }
        #sizeDisplay {
            position: absolute;
            top: 70px;
            left: 20px;
            font-size: 1.2rem;
            color: #4df3ff;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
            z-index: 25;
            background: rgba(0, 20, 50, 0.7);
            padding: 6px 15px;
            border-radius: 30px;
            border: 2px solid #4df3ff;
        }
        #fishCount {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 1.1rem;
            background: rgba(0, 30, 70, 0.7);
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #ffcc00;
            z-index: 25;
        }
        .evolution-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 30, 70, 0.85);
            border-radius: 20px;
            padding: 12px;
            border: 2px solid #4df3ff;
            text-align: center;
            min-width: 150px;
            z-index: 25;
        }
        .stage-name {
            font-size: 1.3rem;
            color: #ffcc00;
            font-weight: bold;
        }
        .progress-container {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #4df3ff, #3a86ff);
            border-radius: 10px;
            transition: width 0.5s;
        }
        .instructions {
            background: rgba(0, 30, 70, 0.85);
            padding: 20px;
            border-radius: 20px;
            margin: 20px 0;
            max-width: 90%;
            border: 2px solid #3a86ff;
            box-shadow: 0 0 15px rgba(58, 134, 255, 0.5);
        }
        .instructions ul {
            text-align: left;
            margin-top: 15px;
            padding-left: 25px;
        }
        .instructions li {
            margin: 12px 0;
            line-height: 1.6;
            font-size: 1.05rem;
        }
        .footer {
            position: absolute;
            bottom: 15px;
            text-align: center;
            width: 100%;
            font-size: 0.9rem;
            color: #a0d2ff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        .fish-icon {
            display: inline-block;
            width: 30px;
            height: 20px;
            margin-right: 10px;
            vertical-align: middle;
            background: #ffcc00;
            border-radius: 50% 50% 50% 0;
            position: relative;
        }
        .fish-icon::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 5px;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-left: 10px solid #ffcc00;
        }
        .bubble {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            bottom: -100px;
            animation: bubble-rise linear infinite;
        }
        @keyframes bubble-rise {
            to {
                transform: translateY(-100vh);
            }
        }
        .stage-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4df3ff;
            margin: 0 3px;
            opacity: 0.3;
            transition: all 0.3s;
        }
        .stage-indicator.active {
            opacity: 1;
            transform: scale(1.4);
            box-shadow: 0 0 8px #4df3ff;
        }
        @media (max-width: 480px) {
            .title {
                font-size: 2.2rem;
            }
            h2 {
                font-size: 1.8rem;
            }
            p {
                font-size: 1rem;
            }
            .btn {
                padding: 12px 35px;
                font-size: 1.1rem;
            }
            #scoreDisplay, #sizeDisplay, #fishCount {
                font-size: 1.1rem;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="uiLayer">
            <div id="scoreDisplay">å¾—åˆ†: 0</div>
            <div id="sizeDisplay">ä½“å‹: èŒèšª</div>
            <div id="fishCount">åƒæ‰å°é±¼: 0</div>
            
            <div class="evolution-display">
                <div class="evolution-title">è¿›åŒ–é˜¶æ®µ</div>
                <div id="stageName" class="stage-name">èŒèšª</div>
                <div class="progress-container">
                    <div id="progressBar" class="progress-bar" style="width: 0%"></div>
                </div>
                <div class="stage-indicators">
                    <div id="stage0" class="stage-indicator active"></div>
                    <div id="stage1" class="stage-indicator"></div>
                    <div id="stage2" class="stage-indicator"></div>
                    <div id="stage3" class="stage-indicator"></div>
                    <div id="stage4" class="stage-indicator"></div>
                    <div id="stage5" class="stage-indicator"></div>
                </div>
            </div>
            
            <div id="startScreen" class="screen">
                <div class="title">æµ·æ´‹è¿›åŒ–ï¼šä»èŒèšªåˆ°é²¨é±¼</div>
                <h2>å¼€å¯ä½ çš„æµ·æ´‹å¾æœä¹‹æ—…</h2>
                
                <div class="instructions">
                    <p>ä»ä¸€åªå°èŒèšªå¼€å§‹ï¼Œé€šè¿‡æ•é£Ÿæˆé•¿ï¼Œæœ€ç»ˆæˆä¸ºæµ·æ´‹éœ¸ä¸»â€”â€”å¤§ç™½é²¨ï¼</p>
                    <ul>
                        <li>ğŸŸ è§¦æ‘¸å±å¹•æ§åˆ¶é±¼å„¿ç§»åŠ¨</li>
                        <li>ğŸ  åƒæ‰æ¯”è‡ªå·±å°çš„é±¼å¯ä»¥æˆé•¿</li>
                        <li>ğŸ¦ˆ èº²é¿æ¯”è‡ªå·±å¤§çš„é±¼ï¼</li>
                        <li>ğŸŒŸ è§£é”6ç§è¿›åŒ–å½¢æ€</li>
                        <li>ğŸ”¥ æŒ‘æˆ˜æœ€é«˜åˆ†ï¼</li>
                    </ul>
                </div>
                
                <button id="startBtn" class="btn">å¼€å§‹è¿›åŒ–ä¹‹æ—…</button>
                <div class="footer">åœ¨å¾®ä¿¡ä¸­æ‰“å¼€å³å¯ç•…ç© | é•¿æŒ‰å±å¹•æ§åˆ¶ç§»åŠ¨</div>
            </div>
            
            <div id="gameOverScreen" class="screen hidden">
                <h2>æ¸¸æˆç»“æŸ</h2>
                <div class="title">æµ·æ´‹éœ¸ä¸»ä¹‹è·¯</div>
                
                <div class="instructions">
                    <p id="finalScore">æœ€ç»ˆå¾—åˆ†: 0</p>
                    <p id="finalStage">è¾¾åˆ°é˜¶æ®µ: èŒèšª</p>
                    <p id="finalFishEaten">åƒæ‰å°é±¼: 0æ¡</p>
                </div>
                
                <button id="restartBtn" class="btn">å†æ¬¡æŒ‘æˆ˜</button>
                <div class="footer">åˆ†äº«ç»™å¥½å‹ä¸€èµ·æŒ‘æˆ˜æœ€é«˜åˆ†ï¼</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const startScreen = document.getElementById('startScreen');
            const gameOverScreen = document.getElementById('gameOverScreen');
            const startBtn = document.getElementById('startBtn');
            const restartBtn = document.getElementById('restartBtn');
            const scoreDisplay = document.getElementById('scoreDisplay');
            const sizeDisplay = document.getElementById('sizeDisplay');
            const fishCount = document.getElementById('fishCount');
            const finalScore = document.getElementById('finalScore');
            const finalStage = document.getElementById('finalStage');
            const finalFishEaten = document.getElementById('finalFishEaten');
            const progressBar = document.getElementById('progressBar');
            const stageName = document.getElementById('stageName');
            const stageIndicators = [
                document.getElementById('stage0'),
                document.getElementById('stage1'),
                document.getElementById('stage2'),
                document.getElementById('stage3'),
                document.getElementById('stage4'),
                document.getElementById('stage5')
            ];

            // è®¾ç½®Canvaså°ºå¯¸
            function resizeCanvas() {
                const gameContainer = document.getElementById('gameContainer');
                canvas.width = gameContainer.clientWidth;
                canvas.height = gameContainer.clientHeight;
            }
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // æ¸¸æˆçŠ¶æ€
            let gameRunning = false;
            let score = 0;
            let playerSize = 20;
            let eatenCount = 0;
            let stage = 0;
            const stageSizes = [20, 40, 70, 110, 160, 220];
            const stageNames = ["èŒèšª", "å°é±¼", "å¤§é±¼", "é‡‘æªé±¼", "æµ·è±š", "å¤§ç™½é²¨"];
            const stageColors = ["#94d2bd", "#6a994e", "#219ebc", "#3a86ff", "#ffb703", "#e63946"];
            const stageSpeeds = [4.0, 3.8, 3.5, 4.2, 4.5, 3.7];

            // ç©å®¶é±¼
            const player = {
                x: canvas.width / 2,
                y: canvas.height / 2,
                size: playerSize,
                speed: stageSpeeds[stage],
                color: stageColors[stage],
                angle: 0
            };

            // é±¼ç±»æ•°ç»„
            let fishes = [];
            let bubbles = [];
            let particles = [];

            // é±¼çš„ç±»å‹
            const fishTypes = [
                { name: "èŒèšª", sizeRange: [15, 25], color: "#94d2bd", speed: 2.5 },
                { name: "å°é±¼", sizeRange: [30, 45], color: "#6a994e", speed: 3 },
                { name: "å¤§é±¼", sizeRange: [50, 70], color: "#219ebc", speed: 2.8 },
                { name: "é‡‘æªé±¼", sizeRange: [80, 100], color: "#3a86ff", speedæ 3.5 },
                { name: "æµ·è±š", sizeRange: [120, 150], color: "#ffb703", speed: 4 },
                { name: "é²¨é±¼", sizeRange: [180, 220], color: "#e63946", speed: 3.2 }
            ];

            // åˆ›å»ºæ°”æ³¡
            function createBubbles() {
                bubbles = [];
                for (let i = 0; i < 30; i++) {
                    bubbles.push({
                        x: Math.random() * canvas.width,
                        y: canvas.height + Math.random() * 100,
                        size: Math.random() * 15 + 5,
                        speed: Math.random() * 2 + 1,
                        startTime: Math.random() * 10
                    });
                }
            }

            // åˆ›å»ºåˆå§‹é±¼ç±»
            function createInitialFishes() {
                fishes = [];
                const count = Math.min(20 + Math.floor(score / 100), 35);
                for (let i = 0; i < count; i++) {
                    const typeIndex = Math.min(stage + Math.floor(Math.random() * 3), 5);
                    const size = Math.random() * (fishTypes[typeIndex].sizeRange[1] - fishTypes[typeIndex].sizeRange[0]) +
                                 fishTypes[typeIndex].sizeRange[0];
                    
                    // éšæœºä½ç½®ï¼ˆåœ¨å±å¹•å¤–ï¼‰
                    let x, y;
                    if (Math.random() > 0.5) {
                        x = Math.random() > 0.5 ? -50 : canvas.width + 50;
                        y = Math.random() * canvas.height;
                    } else {
                        x = Math.random() * canvas.width;
                        y = Math.random() > 0.5 ? -50 : canvas.height + 50;
                    }
                    
                    // è®¾ç½®é±¼æœç©å®¶æ–¹å‘æ¸¸åŠ¨
                    const angle = Math.atan2(player.y - y, player.x - x);
                    fishes.push({
                        x: x,
                        y: y,
                        size: size,
                        speed: fishTypes[typeIndex].speed,
                        color: fishTypes[typeIndex].color,
                        type: typeIndex,
                        angle: angle,
                        wiggle: 0,
                        wiggleSpeed: Math.random() * 0.1 + 0.05
                    });
                }
            }

            // åˆ›å»ºæ–°é±¼
            function createFish() {
                const typeIndex = Math.min(stage + Math.floor(Math.random() * 2), 5);
                const size = Math.random() * (fishTypes[typeIndex].sizeRange[1] - fishTypes[typeIndex].sizeRange[0]) +
                             fishTypes[typeIndex].sizeRange[0];
                
                // éšæœºä½ç½®ï¼ˆåœ¨å±å¹•å¤–ï¼‰
                let x, y;
                if (Math.random() > 0.5) {
                    x = Math.random() > 0.5 ? -50 : canvas.width + 50;
                    y = Math.random() * canvas.height;
                } else {
                    x = Math.random() * canvas.width;
                    y = Math.random() > 0.5 ? -50 : canvas.height + 50;
                }
                
                // è®¾ç½®é±¼æœç©å®¶æ–¹å‘æ¸¸åŠ¨
                const angle = Math.atan2(player.y - y, player.x - x);
                fishes.push({
                    x: x,
                    y: y,
                    size: size,
                    speed: fishTypes[typeIndex].speed,
                    color: fishTypes[typeIndex].color,
                    type: typeIndex,
                    angle: angle,
                    wiggle: 0,
                    wiggleSpeed: Math.random() * 0.1 + 0.05
                });
            }

            // ç»˜åˆ¶æ°”æ³¡
            function drawBubbles() {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                const now = Date.now() / 1000;
                bubbles.forEach(bubble => {
                    // å‚ç›´ç§»åŠ¨
                    const progress = (now - bubble.startTime) * bubble.speed;
                    let yPos = bubble.y - progress * 50;
                    
                    // å¦‚æœæ°”æ³¡è¶…å‡ºå±å¹•ï¼Œé‡ç½®ä½ç½®
                    if (yPos < -50) {
                        bubble.y = canvas.height + Math.random() * 100;
                        bubble.startTime = now;
                        yPos = bubble.y;
                    }
                    
                    ctx.beginPath();
                    ctx.arc(bubble.x, yPos, bubble.size, 0, Math.PI * 2);
                    ctx.fill();
                });
            }

            // ç»˜åˆ¶ç©å®¶
            function drawPlayer() {
                ctx.save();
                ctx.translate(player.x, player.y);
                ctx.rotate(player.angle);
                
                // ç»˜åˆ¶é±¼èº«
                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.ellipse(0, 0, player.size, player.size * 0.6, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // ç»˜åˆ¶å°¾å·´
                const wiggle = Math.sin(Date.now() * 0.01) * 0.3;
                ctx.beginPath();
                ctx.moveTo(-player.size * 0.8, 0);
                ctx.lineTo(-player.size * 1.5, -player.size * 0.7 * Math.sin(wiggle));
                ctx.lineTo(-player.size * 1.5, player.size * 0.7 * Math.sin(wiggle));
                ctx.closePath();
                ctx.fill();
                
                // ç»˜åˆ¶çœ¼ç›
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(player.size * 0.4, -player.size * 0.2, player.size * 0.15, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(player.size * 0.45, -player.size * 0.2, player.size * 0.07, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }

            // ç»˜åˆ¶å…¶ä»–é±¼
            function drawFishes() {
                fishes.forEach(fish => {
                    ctx.save();
                    ctx.translate(fish.x, fish.y);
                    ctx.rotate(fish.angle + fish.wiggle);
                    
                    // æ›´æ–°æ‘†åŠ¨æ•ˆæœ
                    fish.wiggle = Math.sin(Date.now() * fish.wiggleSpeed * 0.001) * 0.3;
                    
                    // ç»˜åˆ¶é±¼èº«
                    ctx.fillStyle = fish.color;
                    ctx.beginPath();
                    ctx.ellipse(0, 0, fish.size, fish.size * 0.6, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ç»˜åˆ¶å°¾å·´
                    ctx.beginPath();
                    ctx.moveTo(-fish.size * 0.8, 0);
                    ctx.lineTo(-fish.size * 1.5, -fish.size * 0.7 * Math.sin(fish.wiggle));
                    ctx.lineTo(-fish.size * 1.5, fish.size * 0.7 * Math.sin(fish.wiggle));
                    ctx.closePath();
                    ctx.fill();
                    
                    // ç»˜åˆ¶çœ¼ç›
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(fish.size * 0.4, -fish.size * 0.2, fish.size * 0.15, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'black';
                    ctx.beginPath();
                    ctx.arc(fish.size * 0.45, -fish.size * 0.2, fish.size * 0.07, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                });
            }

            // ç»˜åˆ¶ç²’å­
            function drawParticles() {
                particles.forEach((p, i) => {
                    ctx.globalAlpha = p.alpha;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalAlpha = 1;
                    
                    // æ›´æ–°ç²’å­
                    p.x += p.vx;
                    p.y += p.vy;
                    p.size *= 0.95;
                    p.alpha *= 0.95;
                    
                    // ç§»é™¤æ¶ˆå¤±çš„ç²’å­
                    if (p.size < 0.2 || p.alpha < 0.05) {
                        particles.splice(i, 1);
                    }
                });
            }

            // åˆ›å»ºç²’å­æ•ˆæœ
            function createParticles(x, y, color, count) {
                for (let i = 0; i < count; i++) {
                    particles.push({
                        x: x,
                        y: y,
                        size: Math.random() * 4 + 2,
                        color: color,
                        vx: (Math.random() - 0.5) * 4,
                        vy: (Math.random() - 0.5) * 4,
                        alpha: 1
                    });
                }
            }

            // è§¦æ‘¸ä½ç½®
            let touchX = canvas.width / 2;
            let touchY = canvas.height / 2;
            
            // è§¦æ‘¸äº‹ä»¶å¤„ç†
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            
            function handleTouch(e) {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                touchX = e.touches[0].clientX - rect.left;
                touchY = e.touches[0].clientY - rect.top;
            }
            
            // é¼ æ ‡äº‹ä»¶å¤„ç†ï¼ˆæ¡Œé¢è°ƒè¯•ç”¨ï¼‰
            canvas.addEventListener('mousedown', handleMouse);
            canvas.addEventListener('mousemove', handleMouse);
            
            function handleMouse(e) {
                const rect = canvas.getBoundingClientRect();
                touchX = e.clientX - rect.left;
                touchY = e.clientY - rect.top;
            }

            // æ›´æ–°ç©å®¶ä½ç½®
            function updatePlayer() {
                // è®¡ç®—åˆ°è§¦æ‘¸ç‚¹çš„æ–¹å‘å’Œè·ç¦»
                const dx = touchX - player.x;
                const dy = touchY - player.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // è®¡ç®—è§’åº¦ï¼ˆç”¨äºé±¼çš„æ–¹å‘ï¼‰
                player.angle = Math.atan2(dy, dx);
                
                // å¦‚æœè·ç¦»å¤§äºé€Ÿåº¦ï¼Œåˆ™ç§»åŠ¨
                if (distance > player.speed) {
                    player.x += (dx / distance) * player.speed;
                    player.y += (dy / distance) * player.speed;
                }
                
                // è¾¹ç•Œæ£€æŸ¥
                player.x = Math.max(player.size, Math.min(canvas.width - player.size, player.x));
                player.y = Math.max(player.size, Math.min(canvas.height - player.size, player.y));
            }

            // æ£€æŸ¥è¿›åŒ–
            function checkEvolution() {
                // è®¡ç®—å½“å‰é˜¶æ®µè¿›åº¦
                let progress = 0;
                let prevSize = stageSizes[stage];
                let nextSize = stageSizes[stage + 1];
                
                if (stage < 5) {
                    if (player.size < nextSize) {
                        progress = ((player.size - prevSize) / (nextSize - prevSize)) * 100;
                    } else {
                        stage++;
                        player.color = stageColors[stage];
                        player.speed = stageSpeeds[stage];
                        stageName.textContent = stageNames[stage];
                        stageIndicators.forEach((indicator, i) => {
                            indicator.classList.toggle('active', i === stage);
                        });
                        progress = ((player.size - stageSizes[stage]) / (stageSizes[stage+1] - stageSizes[stage])) * 100;
                    }
                    progressBar.style.width = `${progress}%`;
 }
            }

            // æ›´æ–°å…¶ä»–é±¼
            function updateFishes() {
                for (let i = fishes.length - 1; i >= 0; i--) {
                    const fish = fishes[i];
                    
                    // ç§»åŠ¨é±¼
                    fish.x += Math.cos(fish.angle) * fish.speed;
                    fish.y += Math.sin(fish.angle) * fish.speed;
                    
                    // è¾¹ç•Œæ£€æŸ¥ - å¦‚æœé±¼ç¦»å¼€å±å¹•ï¼Œåˆ™ç§»é™¤å¹¶åˆ›å»ºæ–°é±¼
                    if (fish.x < -100 || fish.x > canvas.width + 100 || 
                        fish.y < -100 || fish.y > canvas.height + 100) {
                        fishes.splice(i, 1);
                        createFish();
                        continue;
                    }
                    
                    // æ£€æµ‹ä¸ç©å®¶çš„ç¢°æ’
                    const dx = player.x - fish.x;
                    const dy = player.y - fish.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < (player.size + fish.size) * 0.8) {
                        if (player.size > fish.size * 1.1) {
                            // å¢åŠ åˆ†æ•°
                            const sizeBonus = Math.floor(fish.size);
                            score += sizeBonus;
                            eatenCount++;
                            
                            // ç©å®¶é•¿å¤§
                            player.size += fish.size * 0.2;
                            
                            // æ›´æ–°æ˜¾ç¤º
                            scoreDisplay.textContent = `å¾—åˆ†: ${score}`;
                            sizeDisplay.textContent = `ä½“å‹: ${stageNames[stage]}`;
                            fishCount.textContent = `åƒæ‰å°é±¼: ${eatenCount}`;
                            
                            // æ£€æŸ¥è¿›åŒ–
                            checkEvolution();
                            
                            // åˆ›å»ºç²’å­æ•ˆæœ
                            createParticles(fish.x, fish.y, fish.color, 15);
                            
                            // ç§»é™¤è¢«åƒæ‰çš„é±¼å¹¶åˆ›å»ºæ–°é±¼
                            fishes.splice(i, 1);
                            createFish();
                        } else if (fish.size > player.size * 1.1) {
                            // å¦‚æœè¢«å¤§é±¼åƒæ‰ï¼Œæ¸¸æˆç»“æŸ
                            gameOver();
                        }
                    }
                }
            }

            // æ¸¸æˆç»“æŸ
            function gameOver() {
                gameRunning = false;
                finalScore.textContent = `æœ€ç»ˆå¾—åˆ†: ${score}`;
                finalStage.textContent = `è¾¾åˆ°é˜¶æ®µ: ${stageNames[stage]}`;
                finalFishEaten.textContent = `åƒæ‰å°é±¼: ${eatenCount}æ¡`;
                gameOverScreen.classList.remove('hidden');
            }

            // æ¸¸æˆä¸»å¾ªç¯
            function gameLoop() {
                if (!gameRunning) return;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶èƒŒæ™¯
                drawBubbles();
                
                // æ›´æ–°å’Œç»˜åˆ¶ç©å®¶
                updatePlayer();
                drawPlayer();
                
                // æ›´æ–°å’Œç»˜åˆ¶å…¶ä»–é±¼
                updateFishes();
                drawFishes();
                
                // ç»˜åˆ¶ç²’å­
                drawParticles();
                
                // éšæœºç”Ÿæˆæ–°é±¼
                if (Math.random() < (0.01 + score * 0.0001)) {
                    createFish();
                }
                
                requestAnimationFrame(gameLoop);
            }

            // å¼€å§‹æ–°æ¸¸æˆ
            function startGame() {
                startScreen.classList.add('hidden');
                gameOverScreen.classList.add('hidden');
                
                // é‡ç½®æ¸¸æˆçŠ¶æ€
                gameRunning = true;
                score = 0;
                playerSize = 20;
                eatenCount = 0;
                stage = 0;
                
                player.x = canvas.width / 2;
                player.y = canvas.height / 2;
                player.size = playerSize;
                player.speed = stageSpeeds[stage];
                player.color = stageColors[stage];
                
                // é‡ç½®æ˜¾ç¤º
                scoreDisplay.textContent = `å¾—åˆ†: ${score}`;
                sizeDisplay.textContent = `ä½“å‹: ${stageNames[stage]}`;
                fishCount.textContent = `åƒæ‰å°é±¼: ${eatenCount}`;
                stageName.textContent = stageNames[stage];
                progressBar.style.width = '0%';
                
                stageIndicators.forEach((indicator, i) => {
                    indicator.classList.toggle('active', i === 0);
                });
                
                // åˆ›å»ºåˆå§‹é±¼å’Œæ°”æ³¡
                createInitialFishes();
                createBubbles();
                
                // å¼€å§‹æ¸¸æˆå¾ªç¯
                gameLoop();
            }

            // æŒ‰é’®äº‹ä»¶
            startBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('click', startGame);
        });
    </script>
</body>
</html>
